<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>County Stripes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<link href="style.css" rel="stylesheet">
<style>
  body, html { margin: 0; padding: 0; height: 100%; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  #controls {
    position: absolute; top: 10px; left: 10px;
    background: white; padding: 10px; border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif; font-size: 14px;
  }
  .legend-color {
    display: inline-block; width: 16px; height: 16px; margin-right: 6px;
  }
  .legend-title { font-weight: bold; margin-bottom: 4px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="toggleBtn">Switch to Longitude Bands</button><br>
  <label for="colorMode">Color by:</label>
  <select id="colorMode">
    <option value="area">Area</option>
    <option value="population">Population</option>
    <option value="density">Population Density</option>
  </select><br>
  <label for="bandWidthSlider">Band Width (Â°): <span id="bandValue">2</span></label>
  <input type="range" id="bandWidthSlider" min="1" max="20" step="0.1" value="2">
  <div id="legend"></div>
</div>

<script>
const map = new maplibregl.Map({
  container: "map",
  style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center: [-98, 38.5],
  zoom: 4,
  attributionControl: false
});

map.addControl(
  new maplibregl.AttributionControl({
    compact: true,
    customAttribution:
      'Map data Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors | ' +
      '<a href="https://googlemapsmania.blogspot.com/2025/10/county-stripes.html" target="_blank">About this map</a>'
  })
);

let counties;
let bandWidth = 2;
let colorMode = "area";
let bandGeoJSON;
let activePopup = null;

map.on("load", async () => {
  const response = await fetch("countypops.geojson");
  counties = await response.json();

  // ðŸŸ¢ NEW: Load the full US boundary
  const usBoundaryResp = await fetch("custom.geo.json");
  const usBoundary = await usBoundaryResp.json();

  // compute derived properties
  counties.features.forEach(f => {
    const areaSqMiles = turf.area(f) / 2_589_988.11;
    const centroid = turf.centroid(f);
    const pop = Number(f.properties["Total Population"]) || 0;
    const density = pop / areaSqMiles;
    f.properties.area_sq_miles = parseFloat(areaSqMiles.toFixed(1));
    f.properties.centroid_lon = centroid.geometry.coordinates[0];
    f.properties.population = pop;
    f.properties.density = parseFloat(density.toFixed(2));
  });

  function createLongitudeBands(data, width, mode) {
    const bands = {};
    for (const f of data.features) {
      const lon = f.properties.centroid_lon;
      const bandStart = Math.floor(lon / width) * width;
      const key = `${bandStart}`;
      if (!bands[key]) bands[key] = [];
      if (mode === "population") bands[key].push(f.properties.population);
      else if (mode === "density") bands[key].push(f.properties.density);
      else bands[key].push(f.properties.area_sq_miles);
    }
    const features = [];
    for (const [bandStart, values] of Object.entries(bands)) {
      const bandStartNum = parseFloat(bandStart);
      const bandEnd = bandStartNum + width;
      const validVals = values.filter(v => v > 0);
      const avg = validVals.reduce((a, b) => a + b, 0) / (validVals.length || 1);
      features.push({
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [[
            [bandStartNum, 25],
            [bandEnd, 25],
            [bandEnd, 55],
            [bandStartNum, 55],
            [bandStartNum, 25]
          ]]
        },
        properties: { avg_value: avg, bandStart: bandStartNum, bandEnd: bandEnd }
      });
    }
    return { type: "FeatureCollection", features };
  }

  const countyPaints = {
    area: ["interpolate", ["linear"], ["get", "area_sq_miles"],
      0, "#edf8fb", 500, "#b2e2e2", 1000, "#66c2a4", 2000, "#238b45", 4000, "#00441b"],
    population: ["interpolate", ["linear"], ["get", "population"],
      0, "#fff5f0", 10000, "#fcbba1", 50000, "#fc9272", 200000, "#fb6a4a", 1000000, "#a50f15"],
    density: ["interpolate", ["linear"], ["get", "density"],
      0, "#f7fcf5", 10, "#c7e9c0", 100, "#74c476", 500, "#238b45", 2000, "#00441b"]
  };

  const bandPaints = {
    area: ["interpolate", ["linear"], ["get", "avg_value"],
      0, "#edf8fb", 500, "#b2e2e2", 1000, "#66c2a4", 2000, "#238b45", 4000, "#00441b"],
    population: ["interpolate", ["linear"], ["get", "avg_value"],
      0, "#fff5f0", 10000, "#fcbba1", 50000, "#fc9272", 200000, "#fb6a4a", 1000000, "#a50f15"],
    density: ["interpolate", ["linear"], ["get", "avg_value"],
      0, "#f7fcf5", 10, "#c7e9c0", 100, "#74c476", 500, "#238b45", 2000, "#00441b"]
  };

  map.addSource("counties", { type: "geojson", data: counties });
  map.addLayer({
    id: "county-fill",
    type: "fill",
    source: "counties",
    paint: { "fill-color": countyPaints[colorMode], "fill-opacity": 0.7 }
  });
  map.addLayer({
    id: "county-borders",
    type: "line",
    source: "counties",
    paint: { "line-color": "#333", "line-width": 0.4 }
  });

  bandGeoJSON = createLongitudeBands(counties, bandWidth, colorMode);
  map.addSource("lonbands", { type: "geojson", data: bandGeoJSON });
  map.addLayer({
    id: "lonband-fill",
    type: "fill",
    source: "lonbands",
    paint: { 
      "fill-color": bandPaints[colorMode], 
      "fill-opacity": 1.0 // ðŸ”µ MODIFIED â€” now fully opaque
    },
    layout: { visibility: "none" }
  });
  map.addLayer({
    id: "lonband-borders",
    type: "line",
    source: "lonbands",
    paint: { "line-color": "#ff6600", "line-width": 1.5, "line-dasharray": [2, 2] },
    layout: { visibility: "none" }
  });

  // ðŸŸ¢ NEW: Add US boundary layer on top
  // ðŸŸ¢ Add US boundary fill and outline on top
map.addSource("us-boundary", { type: "geojson", data: usBoundary });

// Fill layer â€” light semi-transparent white overlay for clarity
map.addLayer({
  id: "us-fill",
  type: "fill",
  source: "us-boundary",
  paint: {
    "fill-color": "#f8f9fa",   // very light gray/white fill
    "fill-opacity": 0        // soft transparency so you still see band color underneath
  },
  layout: { visibility: "visible" }
});

// Outline layer for crisp borders
map.addLayer({
  id: "us-outline",
  type: "line",
  source: "us-boundary",
  paint: {
    "line-color": "#000",
    "line-width": 1.2
  },
  layout: { visibility: "visible" }
});


    // === CONTROLS ===
  let mode = "county";
  const btn = document.getElementById("toggleBtn");
  const select = document.getElementById("colorMode");
  const slider = document.getElementById("bandWidthSlider");
  const bandValueDisplay = document.getElementById("bandValue");
  const legendDiv = document.getElementById("legend");

  function updateLegend(colorMode, viewMode) {
    const legendStops = {
      area: [0, 500, 1000, 2000, 4000],
      population: [0, 10000, 50000, 200000, 1000000],
      density: [0, 10, 100, 500, 2000]
    };
    const legendColors = {
      area: ["#edf8fb","#b2e2e2","#66c2a4","#238b45","#00441b"],
      population: ["#fff5f0","#fcbba1","#fc9272","#fb6a4a","#a50f15"],
      density: ["#f7fcf5","#c7e9c0","#74c476","#238b45","#00441b"]
    };

    const stops = legendStops[colorMode];
    const colors = legendColors[colorMode];
    let html = `<div class="legend-title">Color by ${colorMode.charAt(0).toUpperCase() + colorMode.slice(1)}</div>`;
    stops.forEach((v, i) => {
      html += `<div><span class="legend-color" style="background:${colors[i]}"></span>${v.toLocaleString()}</div>`;
    });
    legendDiv.innerHTML = html;
  }

  updateLegend(colorMode, mode);

  // ðŸ” Toggle button click
  btn.addEventListener("click", () => {
    if (mode === "county") {
      map.setLayoutProperty("county-fill", "visibility", "none");
      map.setLayoutProperty("county-borders", "visibility", "none");
      map.setLayoutProperty("lonband-fill", "visibility", "visible");
      map.setLayoutProperty("lonband-borders", "visibility", "visible");
      btn.innerText = "Switch to County Coloring";
      mode = "band";
    } else {
      map.setLayoutProperty("county-fill", "visibility", "visible");
      map.setLayoutProperty("county-borders", "visibility", "visible");
      map.setLayoutProperty("lonband-fill", "visibility", "none");
      map.setLayoutProperty("lonband-borders", "visibility", "none");
      btn.innerText = "Switch to Longitude Bands";
      mode = "county";
    }
    updateLegend(colorMode, mode);
  });

  // ðŸŽ¨ Dropdown change
  select.addEventListener("change", () => {
    colorMode = select.value;
    map.setPaintProperty("county-fill", "fill-color", countyPaints[colorMode]);
    map.setPaintProperty("lonband-fill", "fill-color", bandPaints[colorMode]);
    const newBands = createLongitudeBands(counties, bandWidth, colorMode);
    map.getSource("lonbands").setData(newBands);
    updateLegend(colorMode, mode);
  });

  // ðŸ“ Slider change (animated width transition)
  slider.addEventListener("input", () => {
    const newWidth = parseFloat(slider.value);
    bandValueDisplay.textContent = newWidth.toFixed(1);
    const steps = 10;
    const stepSize = (newWidth - bandWidth) / steps;
    let currentStep = 0;
    function animateStep() {
      if (currentStep >= steps) return;
      const intermediateWidth = bandWidth + stepSize * (currentStep + 1);
      const intermediateBands = createLongitudeBands(counties, intermediateWidth, colorMode);
      map.getSource("lonbands").setData(intermediateBands);
      currentStep++;
      requestAnimationFrame(animateStep);
    }
    animateStep();
    bandWidth = newWidth;
  });

});
</script>
</body>
</html>
