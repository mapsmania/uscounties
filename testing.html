<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Interactive U.S. County Map with Custom Longitude Bands</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #controls {
    position: absolute;
    top: 10px; left: 10px; z-index: 1;
    background: white; padding: 8px; border: 1px solid #ccc; font-family: sans-serif;
  }
  #controls label { margin-right: 5px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="toggleBtn">Switch to Longitude Bands</button><br>
  <label for="bandWidthInput">Band Width (Â°):</label>
  <input type="number" id="bandWidthInput" value="2" min="1" max="20" step="1">
</div>

<script>
const map = new maplibregl.Map({
  container: "map",
  style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center: [-98, 38.5],
  zoom: 4,
});

let counties; // will hold GeoJSON

map.on("load", async () => {
  // Load county data
  const response = await fetch("counties.geojson");
  counties = await response.json();

  // Calculate area and centroid longitude
  counties.features.forEach(f => {
    const areaSqMiles = turf.area(f) / 2_589_988.11;
    const centroid = turf.centroid(f);
    f.properties.area_sq_miles = parseFloat(areaSqMiles.toFixed(1));
    f.properties.centroid_lon = centroid.geometry.coordinates[0];
  });

  // --- County layers ---
  map.addSource("counties", { type: "geojson", data: counties });
  map.addLayer({
    id: "county-fill",
    type: "fill",
    source: "counties",
    paint: {
      "fill-color": [
        "interpolate",
        ["linear"],
        ["get", "area_sq_miles"],
        0, "#edf8fb",
        500, "#b2e2e2",
        1000, "#66c2a4",
        2000, "#238b45",
        4000, "#00441b"
      ],
      "fill-opacity": 0.7
    }
  });
  map.addLayer({
    id: "county-borders",
    type: "line",
    source: "counties",
    paint: { "line-color": "#333", "line-width": 0.4 }
  });

  // --- Function to create longitude bands ---
  function createLongitudeBands(counties, bandWidth) {
    const bands = {};
    for (const f of counties.features) {
      const lon = f.properties.centroid_lon;
      const bandStart = Math.floor(lon / bandWidth) * bandWidth;
      const key = `${bandStart}`;
      if (!bands[key]) bands[key] = [];
      bands[key].push(f.properties.area_sq_miles);
    }

    const features = [];
    for (const [bandStart, areas] of Object.entries(bands)) {
      const bandStartNum = parseFloat(bandStart);
      const bandEnd = bandStartNum + bandWidth;
      const bandCenter = bandStartNum + bandWidth/2;
      const avg = areas.reduce((a,b) => a+b, 0) / areas.length;

      features.push({
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [[
            [bandStartNum, 25],
            [bandEnd, 25],
            [bandEnd, 49],
            [bandStartNum, 49],
            [bandStartNum, 25]
          ]]
        },
        properties: { avg_area: avg, bandStart: bandStartNum, bandEnd, bandCenter }
      });
    }

    return { type: "FeatureCollection", features };
  }

  // --- Initialize longitude bands ---
  let bandWidth = parseFloat(document.getElementById("bandWidthInput").value);
  let bandGeoJSON = createLongitudeBands(counties, bandWidth);
  map.addSource("lonbands", { type: "geojson", data: bandGeoJSON });

  map.addLayer({
    id: "lonband-fill",
    type: "fill",
    source: "lonbands",
    paint: {
      "fill-color": [
        "interpolate",
        ["linear"],
        ["get", "avg_area"],
        0, "#edf8fb",
        500, "#b2e2e2",
        1000, "#66c2a4",
        2000, "#238b45",
        4000, "#00441b"
      ],
      "fill-opacity": 0.6
    },
    layout: { visibility: "none" }
  });
  map.addLayer({
    id: "lonband-borders",
    type: "line",
    source: "lonbands",
    paint: { "line-color": "#ff6600", "line-width": 1.5, "line-dasharray":[2,2] },
    layout: { visibility: "none" }
  });

  // --- Toggle button ---
  let mode = "county";
  const btn = document.getElementById("toggleBtn");
  btn.addEventListener("click", () => {
    if(mode === "county") {
      map.setLayoutProperty("county-fill","visibility","none");
      map.setLayoutProperty("county-borders","visibility","none");
      map.setLayoutProperty("lonband-fill","visibility","visible");
      map.setLayoutProperty("lonband-borders","visibility","visible");
      btn.innerText = "Switch to County Coloring";
      mode = "band";
    } else {
      map.setLayoutProperty("county-fill","visibility","visible");
      map.setLayoutProperty("county-borders","visibility","visible");
      map.setLayoutProperty("lonband-fill","visibility","none");
      map.setLayoutProperty("lonband-borders","visibility","none");
      btn.innerText = "Switch to Longitude Bands";
      mode = "county";
    }
  });

  // --- Update bands when input changes ---
  const bandInput = document.getElementById("bandWidthInput");
  bandInput.addEventListener("change", () => {
    bandWidth = parseFloat(bandInput.value);
    const newBands = createLongitudeBands(counties, bandWidth);
    map.getSource("lonbands").setData(newBands);
  });

});
</script>
</body>
</html>
