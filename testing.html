<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>U.S. Counties — Area and Population by Longitude</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1;
    background: rgba(255, 255, 255, 0.95);
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    font-family: 'Segoe UI', sans-serif;
  }

  #toggleBtn, #modeBtn {
    background-color: #ff6600;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    margin-bottom: 10px;
    margin-right: 4px;
    transition: background 0.3s, transform 0.2s;
  }

  #toggleBtn:hover, #modeBtn:hover {
    background-color: #e65500;
    transform: translateY(-2px);
  }

  #bandWidthSlider {
    width: 180px;
    height: 6px;
    border-radius: 3px;
    background: #ddd;
    outline: none;
    -webkit-appearance: none;
    margin-top: 4px;
  }

  #bandWidthSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff6600;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: background 0.3s, transform 0.2s;
  }

  #bandWidthSlider::-webkit-slider-thumb:hover {
    background: #e65500;
    transform: scale(1.2);
  }

  #controls label {
    font-size: 13px;
    margin-bottom: 4px;
    display: block;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="toggleBtn">Switch to Longitude Bands</button>
  <button id="modeBtn">Color by Population</button>
  <label for="bandWidthSlider">Band Width (°): <span id="bandValue">2</span></label>
  <input type="range" id="bandWidthSlider" min="1" max="20" step="0.1" value="2">
</div>

<script>
const map = new maplibregl.Map({
  container: "map",
  style: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
  center: [-98, 38.5],
  zoom: 4,
});

let counties;
let bandWidth = 2;
let bandGeoJSON;
let colorMode = "area"; // 'area' or 'population'
let viewMode = "county"; // 'county' or 'band'

map.on("load", async () => {
  // Load county data
  const response = await fetch("countypops.geojson");
  counties = await response.json();

  // Compute area + centroid longitude
  counties.features.forEach(f => {
    const areaSqMiles = turf.area(f) / 2_589_988.11;
    const centroid = turf.centroid(f);
    f.properties.area_sq_miles = parseFloat(areaSqMiles.toFixed(1));
    f.properties.centroid_lon = centroid.geometry.coordinates[0];

    // Clean population field if needed
    let pop = f.properties["Total Population"];
    if (typeof pop === "string") {
      pop = parseInt(pop.replace(/,/g, ""));
    }
    f.properties.population = pop || 0;
  });

  // --- Define paint styles ---
  const countyPaints = {
    area: [
      "interpolate", ["linear"], ["get", "area_sq_miles"],
      0, "#edf8fb", 500, "#b2e2e2", 1000, "#66c2a4", 2000, "#238b45", 4000, "#00441b"
    ],
    population: [
      "interpolate", ["linear"], ["get", "population"],
      0, "#fff5f0", 10000, "#fcbba1", 50000, "#fc9272", 200000, "#fb6a4a", 1000000, "#a50f15"
    ]
  };

  const bandPaints = {
    area: [
      "interpolate", ["linear"], ["get", "avg_value"],
      0, "#edf8fb", 500, "#b2e2e2", 1000, "#66c2a4", 2000, "#238b45", 4000, "#00441b"
    ],
    population: [
      "interpolate", ["linear"], ["get", "avg_value"],
      0, "#fff5f0", 10000, "#fcbba1", 50000, "#fc9272", 200000, "#fb6a4a", 1000000, "#a50f15"
    ]
  };

  // --- County layers ---
  map.addSource("counties", { type: "geojson", data: counties });
  map.addLayer({
    id: "county-fill",
    type: "fill",
    source: "counties",
    paint: { "fill-color": countyPaints.area, "fill-opacity": 0.7 }
  });
  map.addLayer({
    id: "county-borders",
    type: "line",
    source: "counties",
    paint: { "line-color": "#333", "line-width": 0.4 }
  });

  // --- Function to create longitude bands ---
  function createLongitudeBands(data, width, mode) {
    const bands = {};
    for (const f of data.features) {
      const lon = f.properties.centroid_lon;
      const bandStart = Math.floor(lon / width) * width;
      const key = `${bandStart}`;
      if (!bands[key]) bands[key] = [];
      const value = mode === "area" ? f.properties.area_sq_miles : f.properties.population;
      if (value != null && !isNaN(value)) bands[key].push(value);
    }

    const features = [];
    for (const [bandStart, values] of Object.entries(bands)) {
      const bandStartNum = parseFloat(bandStart);
      const bandEnd = bandStartNum + width;
      const bandCenter = bandStartNum + width / 2;
      const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;

      features.push({
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [[
            [bandStartNum, 25], [bandEnd, 25], [bandEnd, 49], [bandStartNum, 49], [bandStartNum, 25]
          ]]
        },
        properties: { avg_value: avg, bandStart: bandStartNum, bandEnd, bandCenter }
      });
    }

    return { type: "FeatureCollection", features };
  }

  // --- Initialize bands ---
  bandGeoJSON = createLongitudeBands(counties, bandWidth, colorMode);
  map.addSource("lonbands", { type: "geojson", data: bandGeoJSON });
  map.addLayer({
    id: "lonband-fill",
    type: "fill",
    source: "lonbands",
    paint: { "fill-color": bandPaints.area, "fill-opacity": 0.6 },
    layout: { visibility: "none" }
  });
  map.addLayer({
    id: "lonband-borders",
    type: "line",
    source: "lonbands",
    paint: { "line-color": "#ff6600", "line-width": 1.5, "line-dasharray": [2, 2] },
    layout: { visibility: "none" }
  });

  // --- Toggle view mode (county vs bands) ---
  const toggleBtn = document.getElementById("toggleBtn");
  toggleBtn.addEventListener("click", () => {
    if (viewMode === "county") {
      map.setLayoutProperty("county-fill", "visibility", "none");
      map.setLayoutProperty("county-borders", "visibility", "none");
      map.setLayoutProperty("lonband-fill", "visibility", "visible");
      map.setLayoutProperty("lonband-borders", "visibility", "visible");
      toggleBtn.innerText = "Switch to County Coloring";
      viewMode = "band";
    } else {
      map.setLayoutProperty("county-fill", "visibility", "visible");
      map.setLayoutProperty("county-borders", "visibility", "visible");
      map.setLayoutProperty("lonband-fill", "visibility", "none");
      map.setLayoutProperty("lonband-borders", "visibility", "none");
      toggleBtn.innerText = "Switch to Longitude Bands";
      viewMode = "county";
    }
  });

  // --- Toggle color mode (area vs population) ---
  const modeBtn = document.getElementById("modeBtn");
  modeBtn.addEventListener("click", () => {
    if (colorMode === "area") {
      colorMode = "population";
      modeBtn.innerText = "Color by Area";

      // Update counties
      map.setPaintProperty("county-fill", "fill-color", countyPaints.population);

      // Update bands
      const newBands = createLongitudeBands(counties, bandWidth, colorMode);
      map.getSource("lonbands").setData(newBands);
      map.setPaintProperty("lonband-fill", "fill-color", bandPaints.population);

    } else {
      colorMode = "area";
      modeBtn.innerText = "Color by Population";

      // Update counties
      map.setPaintProperty("county-fill", "fill-color", countyPaints.area);

      // Update bands
      const newBands = createLongitudeBands(counties, bandWidth, colorMode);
      map.getSource("lonbands").setData(newBands);
      map.setPaintProperty("lonband-fill", "fill-color", bandPaints.area);
    }
  });

  // --- Slider for band width with animation ---
  const slider = document.getElementById("bandWidthSlider");
  const bandValueDisplay = document.getElementById("bandValue");

  slider.addEventListener("input", () => {
    const newWidth = parseFloat(slider.value);
    bandValueDisplay.textContent = newWidth.toFixed(1);
    const steps = 10;
    const stepSize = (newWidth - bandWidth) / steps;
    let step = 0;

    function animateStep() {
      if (step >= steps) return;
      const intermediateWidth = bandWidth + stepSize * (step + 1);
      const newBands = createLongitudeBands(counties, intermediateWidth, colorMode);
      map.getSource("lonbands").setData(newBands);
      step++;
      requestAnimationFrame(animateStep);
    }

    animateStep();
    bandWidth = newWidth;
  });
});
</script>
</body>
</html>
